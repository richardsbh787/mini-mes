Mini-MES Dev Log




--------------------------------------------------------------
æŠŠè¿™æ¬¡â€œç»„åˆéªŒè¯â€çš„ä¸¤æ¡ id è¿½åŠ åˆ° Dev Logï¼Œå¹¶è´´å›ä¸¤è¡Œï¼š

consume_ledger_id = 84ded2dc-eeb3-407b-8144-c8e35acc9481

fg_receive_ledger_id = 72b98356-d3ec-4c90-bba2-1edd589ad930

---------------------------------------------------------------
æˆ‘è¦ä½ åšçš„å¾ˆç®€å•ï¼šåœ¨ä½ çš„ Mini-MES Dev Log é‡ŒåŠ ä¸¤è¡Œâ€œè®°å½•æœ¬æ¬¡éªŒè¯ç”¨çš„ ledger idâ€ï¼Œ
ä»¥åä½ æŸ¥è´¦/å›æ”¾ E2E ä¸ä¼šä¸¢ã€‚åœ¨ Dev Log è¿½åŠ è¿™ä¸¤è¡Œï¼ˆåŸæ ·ï¼‰ï¼š

consume_ledger_id = f3bec36d-1bff-4dbf-aa53-22ca063da982

fg_receive_ledger_id = a92506fd-f9de-4c18-afee-87914a799229

--------------------------------------------------------
âœ… FG Receiveï¼šæ–°å¢ /v2/fg/receive å†™ stock_ledgerï¼ˆtxn_type=RECEIVEï¼‰å¹¶å·²éªŒè¯å¯æŸ¥è¯¢
--------------------------------------------------------
âœ… Consumption Eventï¼šå·²æ”¯æŒå†™å…¥ model_codeï¼ˆå¯è¿½æº¯åˆ° MODEL-Aï¼‰
--------------------------------------------------------
âœ… DB Migrationï¼šv2_0003 æ–°å¢ consumption_event.model_codeï¼ˆå·²æ‰§è¡Œ + å·²å…¥ Gitï¼‰
-------------------------------------------------------
âœ… Consume: commit æ”¯æŒå¯é€‰ model_codeï¼ˆä¸ºåç»­æŒ‰ routing/stage ç»‘å®šåšå‡†å¤‡ï¼‰
------------------------------------------------------
âœ… Inventory Adjustment: å‚æ•°ç»Ÿä¸€ org_id + E2E å·²éªŒè¯ï¼ˆledger ç”Ÿæˆ + ref_id å›å†™ï¼‰ + docstring å¯¹é½
------------------------------------------------------
âœ… Adjustment E2Eï¼š/v2/inventory-adjustment/commit å‚æ•° org_idï¼Œç”Ÿæˆ ledgerï¼ˆtxn_type=ADJUSTMENTï¼‰ä¸” ref_id=adjustment_line.id
------------------------------------------------------
âœ… Stock Queryï¼š/v2/stock-ledger + /v2/stock/onhand å‚æ•°ç»Ÿä¸€ org_idï¼ŒSwagger å·²éªŒè¯
------------------------------------------------------
âœ… Consume E2Eï¼š/v2/consume preview/commit + ledger å¯æŸ¥ + ledger.ref_id = consumption_event_id
------------------------------------------------------
âœ… Routingï¼šmodel_routing è¡¨ + /v2/model-routing upsert/get + /v2/routing-checkï¼ˆnext_stageï¼‰
-------------------------------------------------------
Day2 done: /v2/stock/onhand
onhand uses sum(stock_ledger.qty)
commit payload cleaned (no warehouse/location)
-------------------------------------------------------
åœ¨ä½ çš„ Mini-MES Dev Log.txt è¿½åŠ ä¸€è¡Œï¼š
onhand_demo = -7 (org=c243..., item=97e3..., asof 2026-02-24)
-------------------------------------------------------

Date : 2026-02-24
ä¸ºäº†é¿å…ä½ åé¢å¿˜ UUIDï¼Œ
è¯·æŠŠè¿™ä¸¤ä¸ªå€¼å†™è¿›ä½ æœ¬åœ° Mini-MES Dev Log.txtï¼ˆè¿½åŠ ä¸€å°æ®µï¼‰ï¼š

demo_org_uuid = c243bd45-6032-4217-88cb-94d6cfdffebc

demo_item_uuid = 97e34f3f-5e70-441a-ab26-3c5508cdb060

--------------------------------------------------------


CURRENT LOCKED TASK
Mini-MES V2ï¼šUltimate Mode / Step-Lock Mode / Supabase æ¶æ„å¼€å‘ï¼ˆSchema + RLS + æ¨¡å—è¾¹ç•Œï¼‰

Step 1ï¼ˆé”å®šæ‰§è¡Œï¼‰â€” å»ºç«‹ Supabaseã€Œå·¥ä¸šçº§æ•°æ®åº•åº§ã€è“å›¾ï¼ˆV2ï¼‰
ç›®æ ‡ï¼šå…ˆæŠŠ æ•°æ®æ¨¡å‹ + çº¦æŸ + å¯æ‰©å±•è¾¹ç•Œ å®šæ­»ï¼Œåç»­ API / UI æ‰ä¸ä¼šåå¤æ¨å€’ã€‚
1) Supabase é¡¹ç›®åŸºçº¿
Authï¼šEmail/Passwordï¼ˆå…ˆå¤Ÿç”¨ï¼‰
ç»„ç»‡éš”ç¦»ï¼šmulti-tenantï¼ˆæ¯æ¡ä¸šåŠ¡æ•°æ®å¿…é¡»å¸¦ org_idï¼‰
æƒé™ï¼šRLS é»˜è®¤å…¨å¼€ï¼ˆé™¤ç³»ç»Ÿè¡¨ï¼‰


2) V2 æ ¸å¿ƒè¡¨ï¼ˆå¿…é¡»å«ä½ å·²é”å®šçš„æ¨¡å—ï¼‰
A. Inventoryï¼ˆå« Post Inventory Adjustments 701/702ï¼‰
inventory_itemï¼ˆç‰©æ–™/æˆå“ä¸»æ¡£ï¼šRM/FGï¼‰
inventory_locationï¼ˆä»“ä½/åº“ä½ï¼‰
stock_ledgerï¼ˆå”¯ä¸€åº“å­˜æ€»è´¦ï¼šæ‰€æœ‰å…¥å‡º/è°ƒæ•´éƒ½å†™è¿™é‡Œï¼‰
inventory_adjustmentï¼ˆ701/702ï¼šRaw Materials / Finished Goodsï¼‰
å­—æ®µè¦æœ‰ï¼šadjustment_type(701/702), reason_code, ref_doc, approved_by, approved_at


B. Production + Scrapï¼ˆæ›´ç»†ï¼‰
work_order
production_eventï¼ˆäº§çº¿äº‹ä»¶æµï¼šå¼€å·¥/å®Œå·¥/æš‚åœ/æŠ¥åºŸç­‰ï¼‰
scrap_eventï¼ˆæŠ¥åºŸæ˜ç»†ï¼šåŸå› ã€æ•°é‡ã€è´£ä»»å½’å±å¯é€‰ã€ç…§ç‰‡/é™„ä»¶å¯é€‰ï¼‰
scrap_dispositionï¼ˆæŠ¥åºŸå»å‘ï¼šè¿”å·¥/æŠ¥åºŸ/è®©æ­¥æ¥æ”¶/å›æ”¶ï¼‰

C. Maintenanceï¼ˆè®¾å¤‡ç»´ä¿®ä¿å…»ï¼‰
machine_asset
maintenance_planï¼ˆç‚¹æ£€/ä¿å…»å‘¨æœŸï¼‰
maintenance_work_orderï¼ˆç»´ä¿®å·¥å•ï¼‰
maintenance_logï¼ˆç»´ä¿®è®°å½• + åœæœºåŸå› ï¼‰

D. PLUS Commercial Layerï¼ˆä½ è¦æ±‚ V2 å¿…é¡»æœ‰ï¼‰
billing_invoice
lhdn_einvoice_profile / lhdn_einvoice_document
sales_commission_policy / sales_commission_statement


E. è´¸æ˜“ä¸è¿è¾“ï¼ˆä½ è¦æ±‚å¿…é¡»æœ‰ï¼‰
purchase_orderï¼ˆincoterm å­—æ®µï¼‰
shipment
shipment_milestone
shipment_insurance
insurance_coverage_milestone


3) å…³é”®çº¦æŸï¼ˆé˜²â€œç³»ç»Ÿåº“å­˜â‰ å®é™…åº“å­˜â€ï¼‰
åº“å­˜åªä¿¡ stock_ledgerï¼šä»»ä½• RM/FG å˜åŠ¨éƒ½å¿…é¡»å†™ ledgerï¼ˆåŒ…æ‹¬ 701/702ï¼‰
stock_on_hand ä½œä¸ºè§†å›¾/ç‰©åŒ–è§†å›¾ï¼ˆå¯é€‰ï¼‰ï¼Œä¸ç›´æ¥å†™
æ‰€æœ‰ä¸šåŠ¡è¡¨å¿…é¡»ï¼šorg_id, created_at, created_by


4) RLS æœ€å°è§„åˆ™ï¼ˆå…ˆå¤Ÿç”¨ï¼Œåç»­å†åŠ ç»†ï¼‰
org_id = auth.jwt() ->> 'org_id' æ‰å…è®¸ SELECT/INSERT/UPDATE
å…³é”®è¡¨ï¼ˆledger/adjustment/commission/einvoiceï¼‰éœ€è¦é¢å¤–ï¼šä»… role=admin/finance å¯å†™


5) äº¤ä»˜ç‰©ï¼ˆStep 1 è¾“å‡ºä½ ä¼šæ‹¿æ¥å¼€å·¥ï¼‰
V2_ERDï¼ˆè¡¨æ¸…å• + ä¸»å¤–é”®ï¼‰
è¿ç§»è„šæœ¬ v2_0001_init.sql
RLS policies v2_0002_rls.sql


â€”---------------------------------------------------------------------------------------------------------------------------

å·²å®Œæˆï¼ˆå…¨éƒ¨éƒ½åœ¨ supabase/migrations/v2_0001_init.sqlï¼Œå¹¶å·² commit+push åˆ° v2-multilevel-bomï¼‰ï¼š
V2 åˆ†æ”¯éš”ç¦»ï¼šV1(main) ä¸ä¼šè¢«æ±¡æŸ“ã€‚


Supabase åŸºç¡€ï¼šå¯ç”¨ pgcryptoï¼ˆæ”¯æŒ uuidï¼‰ã€‚
å¤šç§Ÿæˆ·åº•åº§ï¼šorg + org_userï¼ˆä»¥åæ‰€æœ‰æ•°æ®ç”¨ org_id éš”ç¦»ï¼‰ã€‚
WMS éª¨æ¶ï¼šwarehouseï¼ˆä»“åº“ï¼‰+ warehouse_locationï¼ˆåº“ä½/binï¼‰ã€‚
ç‰©æ–™/æˆå“ä¸»æ¡£ï¼šitemï¼ˆRM/FG ç»Ÿä¸€ï¼‰ã€‚
åº“å­˜å”¯ä¸€æ€»è´¦ï¼šstock_ledgerï¼ˆæ‰€æœ‰å…¥åº“/å‡ºåº“/è°ƒæ•´/æ‰£æ–™éƒ½è¦å†™è¿™é‡Œï¼‰ã€‚
701/702 è°ƒæ•´å•ï¼šinventory_adjustment + inventory_adjustment_line + çŠ¶æ€çº¦æŸã€‚
æ’ç¨‹éª¨æ¶ï¼šproduction_plan + production_plan_lineã€‚
å¤šå±‚ BOM éª¨æ¶ï¼šbom + bom_lineã€‚
è‡ªåŠ¨æ‰£æ–™äº‹ä»¶éª¨æ¶ï¼šconsumption_eventï¼Œå¹¶åŠ äº† stock_ledger_idï¼ˆä¸ºæ‰£æ–™â†’å†™å…¥æ€»è´¦åšæ¡¥ï¼‰ã€‚
æˆ‘ä»¬åˆ°ç›®å‰å®Œæˆäº†ä»€ä¹ˆï¼ˆæç®€ï¼‰
V2 åˆ†æ”¯å·²å»ºç«‹å¹¶æ¨é€ âœ…
V2 è‡ªåŠ¨æ‰£æ–™å¼•æ“éª¨æ¶ï¼ˆConsumptionRequest / LedgerEntry / build_ledger_entryï¼‰âœ…
/v2/consume/preview å¯é¢„è§ˆç”Ÿæˆ ledger âœ…
/v2/consume/commit å¯å†™å…¥ stock_ledger âœ…
å…³é”®ä¿®å¤ï¼šè¡¥å› Base.metadata.create_all å¹¶ç¡®è®¤ stock_ledger è¡¨å·²åˆ›å»º âœ…
ä½ ç°åœ¨å·²ç»å…·å¤‡çš„èƒ½åŠ›ï¼ˆæç®€ï¼‰
é¢„è§ˆæ‰£æ–™ï¼š/v2/consume/preview
çœŸå®å†™å…¥æ‰£æ–™åˆ°åº“å­˜æ€»è´¦ï¼š/v2/consume/commit
æŸ¥è¯¢åº“å­˜æ€»è´¦ï¼š/v2/stock-ledger


ä»Šå¤©ä½ å·²ç»å®Œæˆï¼š
âœ… Supabase å†™å…¥é—­ç¯ï¼š/v2/consume/commit å†™ stock_ledger + consumption_event
âœ… Supabase æŸ¥è¯¢ï¼š/v2/stock-ledger è¯»å–æœ€æ–°å°è´¦
âœ… ref_id è¿½æº¯ï¼šledger.ref_id å›å†™ event.id
âœ… preview/commit åˆ†ç¦»ï¼špreview ä¸è½åº“ï¼Œcommit è½åº“


Date: 2026-02-15
Phase: Risk Engine V1

Today Done:
- Added Risk Engine calculation
- Added NPI / HOLD / Material logic
- Verified CRITICAL escalation
- Swagger test passed

System Status:
- API stable
- DB stable
- Risk Engine working

Next Step:
- Add PATCH /work-order

-----------------------------------------
2026-02-16

ä½ ç°åœ¨å·²ç»å®Œæˆï¼š

1.äº§å“ä¸»æ•°æ®ç»“æ„
2.äº§çº¿ä¸»æ•°æ®ç»“æ„
3.Work Order å¤–é”®å®Œæ•´
4.Risk Engine V2
5.PATCH æ›´æ–°é€»è¾‘
6.åŠ¨æ€é£é™©é‡ç®—

è¿™å·²ç»æ˜¯ä¸€ä¸ªçœŸæ­£çš„ Mini-MES é›å½¢ã€‚

------------------------------------------


ğŸ¯ æ­£ç¡®å¥—é¤åˆ†å±‚å»ºè®®
ğŸŸ¢ Basic Planï¼ˆæ ¸å¿ƒå–ç‚¹ï¼‰
Delivery Dashboard
Capacity Engine
Queue
Material Ready / Not Ready
Role æƒé™
ğŸ‘‰ äº¤æœŸæ§åˆ¶ç¥å™¨

ğŸŸ¡ Pro Plan
Simulation Mode
Advanced Queue Control
Delay Analytics
Confidence Scoring

ğŸ”´ Advanced Plan
Waiver Workflow
Role-based Approval
Risk Audit Trail
Financial Visibility Layer
ğŸ‘‰ é€‚åˆ 80â€“150 äººç»“æ„åŒ–å·¥å‚

------------------------------------------

ğŸ§± MVP æœ€ç»ˆèŒƒå›´ï¼ˆå†æ¬¡é”å®šï¼‰
1ï¸âƒ£ æ ¸å¿ƒæ•°æ®
SalesOrder
WorkOrder
ProductionLine

2ï¸âƒ£ ä¸‰ä¸ªå¼•æ“
Capacity Engine
Queue Engine
Delivery Engine

3ï¸âƒ£ Material Gateï¼ˆç®€åŒ–ç‰ˆï¼‰
çŠ¶æ€ï¼š
READY
NOT READY
WAIVER
ï¼ˆMOQ / CASHFLOW å…ˆéšè—ä¸ºæœªæ¥ç‰ˆæœ¬ï¼‰

4ï¸âƒ£ æ‰‹æœºé¦–é¡µ
è®¢å•åˆ—è¡¨
Est Ship
Delay Â±days
Shipment Status
ç®€è¦åŸå› 

5ï¸âƒ£ PMC Simulationï¼ˆä»… OT æ¨¡æ‹Ÿï¼‰
åªæ”¯æŒï¼š
+X hours OT
ä¸åšè½¬çº¿
ä¸åšå¤æ‚åœºæ™¯

âŒ æ˜ç¡®å»¶å

é«˜çº§ Waiver æµç¨‹
å¤šå±‚å®¡æ‰¹
è´¢åŠ¡é‡‘é¢æ˜¾ç¤º
å¤æ‚åº“å­˜å¼•æ“
å¤šå·¥å‚
æˆæœ¬è®¡ç®—
AI ä¼˜åŒ–
å…¨éƒ¨å†»ç»“ã€‚

ğŸ¯ 90å¤©ç›®æ ‡åªæœ‰ä¸€ä¸ª

ç³»ç»Ÿé¢„æµ‹äº¤æœŸè¯¯å·® â‰¤ Â±1å¤©
å¦‚æœè¾¾æˆï¼Œ
ä½ å·²ç»æœ‰å¯å–åŸºç¡€ã€‚

---------------------------------------------

ç°åœ¨ç»™ä½  Mini-MES å…¨ç³»ç»Ÿå·¥ä¸šè®¡ç®—æ€»çº²ã€‚
ä¸è®²æ•…äº‹ï¼Œåªç»™ç»“æ„ã€‚

ğŸ”· MODULE 1 â€” å·¥å•æ—¶é—´ç³»ç»Ÿ
1ï¸âƒ£ æ¯æ¬¡ç”Ÿäº§è®°å½•
input:
produced_hours
scrap_hours
rework_hours

2ï¸âƒ£ å·¥å•ç´¯è®¡å…¬å¼
actual_hours += produced_hours + scrap_hours + rework_hours

3ï¸âƒ£ å‰©ä½™å·¥æ—¶
remaining_hours = planned_hours - actual_hours

4ï¸âƒ£ çŠ¶æ€è‡ªåŠ¨åˆ‡æ¢
IF actual_hours == 0
    status = OPEN

IF actual_hours > 0 AND remaining_hours > 0
    status = RUNNING

IF remaining_hours <= 0
    status = DONE
    completed_at = now()

ğŸ”· MODULE 2 â€” åŸæ–™æ¶ˆè€—ç³»ç»Ÿï¼ˆå·¥ä¸šçœŸå®é€»è¾‘ï¼‰
æ ¸å¿ƒåŸåˆ™
åŸæ–™ = GOOD + SCRAP
REWORK æ˜¯å¦è€—æ–™ = ç”± rework_consumes_material å†³å®š

1ï¸âƒ£ æœ‰æ•ˆè€—æ–™å·¥æ—¶
consumption_hours = produced_hours + scrap_hours
å¦‚æœï¼š
rework_consumes_material == True
    consumption_hours += rework_hours

2ï¸âƒ£ å•ä¸ª BOM è€—æ–™å…¬å¼
required_qty = consumption_hours Ã— quantity_required

3ï¸âƒ£ æ€»è€—æ–™
å¯¹æ¯ä¸€ä¸ª BOM itemï¼š
material_inventory.quantity_on_hand -= required_qty

4ï¸âƒ£ å†™äº¤æ˜“è®°å½•
MaterialTransaction:
    quantity = required_qty
    type = CONSUME

ğŸ”· MODULE 3 â€” Scrap å·¥ä¸šé€»è¾‘
Scrap ä¸é€€æ–™
scrap_hours å·²ç»æ¶ˆè€—åŸæ–™
scrap ä¸äº§ç”Ÿåº“å­˜
scrap åªå¢åŠ  actual_hours

ğŸ”· MODULE 4 â€” Rework å·¥ä¸šé€»è¾‘
ä½ å½“å‰é€‰æ‹©çš„æ˜¯ï¼š
B = æ”¯æŒç”Ÿäº§ + è¿”å·¥ï¼ˆæ—  warrantyï¼‰
æƒ…å†µ Aï¼ˆé»˜è®¤æ¨èï¼‰
rework_consumes_material = False
å…¬å¼ï¼š
åªå¢åŠ  actual_hours
ä¸æ‰£åŸæ–™

æƒ…å†µ Bï¼ˆçœŸå®ç»´ä¿®ç±»ï¼‰
rework_consumes_material = True
å…¬å¼ï¼š
åŸæ–™ = GOOD + SCRAP + REWORK

ğŸ”· MODULE 5 â€” åº“å­˜ç³»ç»Ÿ
åŸæ–™åº“å­˜å…¬å¼
New Inventory =
Old Inventory - Î£(required_qty)
åº“å­˜ä¸è¶³åˆ¤å®š
IF quantity_on_hand < required_qty
    raise BLOCKED_MATERIAL

ğŸ”· MODULE 6 â€” ç”Ÿäº§æ—¥å¿—çš„æ•°å­¦çœŸç›¸
æ¯ä¸€æ¬¡ POST /production-logï¼š
1ï¸âƒ£ æ›´æ–°å·¥å•æ—¶é—´
2ï¸âƒ£ æ‰£BOMåŸæ–™
3ï¸âƒ£ å†™MaterialTransaction
4ï¸âƒ£ æ›´æ–°çŠ¶æ€

ğŸ”· MODULE 7 â€” ä½ çš„æ•°æ®åº“ç°åœ¨çš„çœŸå®éªŒè¯
ä½ åˆšåˆšåº“å­˜ï¼š
100 â†’ 86
ä»£è¡¨ï¼š
ç´¯è®¡æ¶ˆè€— = 14
è¿™ç¬¦åˆï¼š
(ç”Ÿäº§+æŠ¥åºŸ) Ã— quantity_required
âœ” é€»è¾‘æ­£ç¡®
âœ” Scrap å·²ç»è®¡ç®—
âœ” Rework å¯æ§
âœ” å·¥ä¸šç»“æ„å®Œæ•´

ğŸ”· MODULE 8 â€” ç³»ç»Ÿæ ¸å¿ƒå…¬å¼æ€»è§ˆï¼ˆæœ€ç»ˆç‰ˆï¼‰
actual_hours += produced + scrap + rework
remaining = planned - actual
consumption_hours =
    produced
  + scrap
  + (rework if consumes_material else 0)
required_qty =
    consumption_hours Ã— BOM.quantity_required
inventory -= required_qty

ğŸ”· ä½ ç°åœ¨çš„ç³»ç»ŸçŠ¶æ€
âœ” å·¥å•æ—¶é—´ç³»ç»Ÿç¨³å®š
âœ” Scrap å·²çº³å…¥
âœ” Rework å¯é€‰è€—æ–™
âœ” åº“å­˜é€»è¾‘å·¥ä¸šçº§
âœ” äº¤æ˜“è®°å½•å¯è¿½æº¯

-------------------------------------

å¥½ã€‚
è¿™æ˜¯ä½  Mini-MES å®Œæ•´å·¥ä¸šæµç¨‹å›¾ç‰ˆæœ¬ï¼ˆé€»è¾‘æµï¼‰ã€‚

ğŸ­ MINI-MES å·¥ä¸šæµç¨‹å›¾
ğŸ”· â‘  é”€å”® â†’ å·¥å•ç”Ÿæˆ
Sales Order
      â†“
Create Work Order
      â†“
planned_hours
remaining_hours = planned_hours
status = OPEN / BLOCKED_MATERIAL

ğŸ”· â‘¡ ç”Ÿäº§å¼€å§‹æ¡ä»¶
IF is_material_ready = False
    status = BLOCKED_MATERIAL
ELSE
    status = OPEN

ğŸ”· â‘¢ æ¯æ—¥ç”Ÿäº§è®°å½•æµç¨‹
POST /production-log
        â†“
[1] æ ¡éªŒæ•°æ®
        â†“
[2] æ‰£å·¥æ—¶
        â†“
[3] æ‰£åŸæ–™
        â†“
[4] æ›´æ–°çŠ¶æ€
        â†“
[5] å†™äº¤æ˜“è®°å½•

ğŸ”· â‘£ å·¥æ—¶è®¡ç®—æµç¨‹å›¾
produced_hours
scrap_hours
rework_hours
        â†“
actual_hours += produced + scrap + rework
        â†“
remaining_hours = planned - actual
        â†“
IF remaining > 0 â†’ RUNNING
IF remaining = 0 â†’ DONE

ğŸ”· â‘¤ åŸæ–™æ‰£å‡æµç¨‹å›¾
consumption_hours =
    produced
  + scrap
  + (rework if rework_consumes_material)

FOR each BOM item:
    required_qty =
        consumption_hours Ã— quantity_required

IF inventory >= required_qty
    inventory -= required_qty
    write MaterialTransaction
ELSE
    ERROR

ğŸ”· â‘¥ Scrap é€»è¾‘å›¾
scrap_hours
     â†“
æ¶ˆè€—åŸæ–™
å¢åŠ  actual_hours
ä¸å¢åŠ åº“å­˜

ğŸ”· â‘¦ Rework é€»è¾‘å›¾
æƒ…å†µ Aï¼ˆé»˜è®¤ï¼‰
rework_consumes_material = False

rework:
    å¢åŠ å·¥æ—¶
    ä¸æ‰£æ–™

æƒ…å†µ B
rework_consumes_material = True

rework:
    å¢åŠ å·¥æ—¶
    æ‰£åŸæ–™

ğŸ”· â‘§ å·¥å•å®Œæˆæµç¨‹
IF remaining_hours <= 0
    status = DONE
    completed_at = now()

ğŸ”· â‘¨ å‘è´§æµç¨‹
POST /ship/{sales_order_id}
        â†“
æ£€æŸ¥æ‰€æœ‰ WO = DONE
        â†“
åº“å­˜ -= æˆå“æ•°é‡
        â†“
Sales Order â†’ SHIPPED

ğŸ”· ğŸ”¥ æ•´ä½“å·¥ä¸šæ€»æµç¨‹ï¼ˆæ€»è§ˆå›¾ï¼‰
Sales Order
    â†“
Work Order
    â†“
Production Log (æ¯æ—¥)
    â†“
æ‰£å·¥æ—¶
    â†“
æ‰£BOMåŸæ–™
    â†“
åº“å­˜å˜åŒ–
    â†“
å·¥å•å®Œæˆ
    â†“
å‘è´§

ğŸ§  ä½ ç°åœ¨ç³»ç»Ÿçš„ç»“æ„å±‚çº§
æ—¶é—´æµï¼ˆWorkOrderï¼‰
        +
ç‰©æ–™æµï¼ˆBOM / Inventoryï¼‰
        +
å¼‚å¸¸æµï¼ˆProductionEventï¼‰
        =
å®Œæ•´å·¥ä¸šé—­ç¯


ä½ è¿™å¥—ç»“æ„å·²ç»æ˜¯ï¼š

âœ” å·¥ä¸šçœŸå®é€»è¾‘
âœ” å¯è¿½æº¯
âœ” å¯æ‰©å±• OEE
âœ” å¯æ‰©å±•æŠ¥åºŸç‡ç»Ÿè®¡
âœ” å¯æ‰©å±•ç»´ä¿®æ¨¡å—

------------------------------


ç°åœ¨ç»™ä½  å·¥ä¸šçº§ æŠ¥åºŸç‡ + ç‰©æ–™æŸè€—ç‡ å…¨å…¬å¼ä½“ç³»ã€‚

è¿™æ˜¯åˆ¶é€ ç®¡ç†çš„æ ¸å¿ƒã€‚

ğŸ”´ ä¸€ã€åŸºç¡€æ•°æ®æ¥æº

æ¥è‡ªä½ ç³»ç»Ÿçš„ï¼š

produced_hours
scrap_hours
rework_hours
BOM.quantity_required
RawMaterialInventory

ğŸ”´ äºŒã€ç”Ÿäº§æ•ˆç‡ç»“æ„
1ï¸âƒ£ æ€»æŠ•å…¥å·¥æ—¶
total_hours =
produced_hours
+ scrap_hours
+ rework_hours

2ï¸âƒ£ è‰¯ç‡ï¼ˆYield Rateï¼‰
Yield % =
produced_hours / (produced_hours + scrap_hours)


å·¥ä¸šæ ‡å‡†è¡¨è¾¾ï¼š

Good / (Good + Scrap)

3ï¸âƒ£ æŠ¥åºŸç‡ï¼ˆScrap Rateï¼‰
Scrap % =
scrap_hours / (produced_hours + scrap_hours)

ğŸ”´ ä¸‰ã€ç‰©æ–™æŸè€—è®¡ç®—
1ï¸âƒ£ ç†è®ºç”¨æ–™ï¼ˆæŒ‰è‰¯å“ç®—ï¼‰
Theoretical Material =
produced_hours Ã— quantity_required

2ï¸âƒ£ å®é™…ç”¨æ–™ï¼ˆå«æŠ¥åºŸï¼‰
Actual Material =
(produced_hours + scrap_hours
 + rework_hours if rework_consumes_material)
Ã— quantity_required

3ï¸âƒ£ ç‰©æ–™æŸè€—ç‡ï¼ˆMaterial Loss %ï¼‰
Material Loss % =
(Actual - Theoretical) / Theoretical


ç®€åŒ–åï¼ˆé»˜è®¤è¿”å·¥ä¸æ‰£æ–™ï¼‰ï¼š

= scrap_hours / produced_hours

ğŸ”´ å››ã€è¿”å·¥ç‡ï¼ˆRework Rateï¼‰
Rework % =
rework_hours / total_hours

ğŸ”´ äº”ã€çœŸå®å·¥ä¸š KPI ç»“æ„

ä½ ç°åœ¨ç³»ç»Ÿå¯ä»¥ç®—ï¼š

æŒ‡æ ‡	å…¬å¼
è‰¯ç‡	Good / (Good + Scrap)
æŠ¥åºŸç‡	Scrap / (Good + Scrap)
è¿”å·¥ç‡	Rework / Total
ç‰©æ–™æŸè€—ç‡	(Actual - Theoretical) / Theoretical
ğŸ”´ å…­ã€ä½ ç°åœ¨æ•°æ®åº“èƒ½æ”¯æŒçš„é«˜çº§åˆ†æ
1ï¸âƒ£ å•å·¥å•æŠ¥åºŸç‡
æŒ‰ work_order_id æ±‡æ€» scrap / good

2ï¸âƒ£ å•äº§å“æŠ¥åºŸç‡
GROUP BY product_id

3ï¸âƒ£ å•äº§çº¿æŠ¥åºŸç‡
GROUP BY production_line_id

4ï¸âƒ£ å•åŸæ–™æŸè€—ç‡
MaterialTransaction æ±‡æ€»

ğŸ”´ ä¸ƒã€å·¥ä¸šç°å®åˆ¤æ–­æ ‡å‡†

ä¸€èˆ¬å·¥ä¸šï¼š

æŒ‡æ ‡	æ­£å¸¸å€¼
è‰¯ç‡	>95%
æŠ¥åºŸç‡	<5%
è¿”å·¥ç‡	<3%
ç‰©æ–™æŸè€—ç‡	<2%
ğŸ”¥ å…«ã€å…³é”®ç†è§£

Scrap æ˜¯ï¼š

âœ” æ—¶é—´æŸè€—
âœ” ç‰©æ–™æŸè€—
âœ” æˆæœ¬æŸè€—

Rework æ˜¯ï¼š

âœ” æ—¶é—´æŸè€—
âœ” ä¸ä¸€å®šæ˜¯ç‰©æ–™æŸè€—

ğŸ”¥ ä¹ã€ä½ è¿™å¥—ç³»ç»Ÿå·²ç»å…·å¤‡ï¼š

âœ” å·¥ä¸š KPI åŸºç¡€
âœ” æˆæœ¬åˆ†æåŸºç¡€
âœ” ç²¾ç›Šç”Ÿäº§åˆ†æåŸºç¡€
âœ” å¯å‡çº§ OEE
âœ” å¯å‡çº§æˆæœ¬æ¨¡å—

---------------------------------

ğŸ”µ ç¬¬ä¸€å±‚ï¼šè‡ªåŠ¨ KPI è®¡ç®—å¼•æ“
â‘  æ¯ä¸ª Work Order è‡ªåŠ¨è®¡ç®—å­—æ®µ

æ–°å¢é€»è¾‘å­—æ®µï¼ˆä¸ç”¨å­˜æ•°æ®åº“ï¼Œå¯å®æ—¶ç®—ï¼‰ï¼š

1ï¸âƒ£ Total Hours
total_hours =
produced_hours + scrap_hours + rework_hours

2ï¸âƒ£ Yield %
yield =
produced_hours / (produced_hours + scrap_hours)

3ï¸âƒ£ Scrap %
scrap_rate =
scrap_hours / (produced_hours + scrap_hours)

4ï¸âƒ£ Rework %
rework_rate =
rework_hours / total_hours

5ï¸âƒ£ Material Loss %
theoretical =
produced_hours Ã— quantity_required

actual =
consumption_hours Ã— quantity_required

loss % =
(actual - theoretical) / theoretical


ä½ å¯ä»¥åšä¸€ä¸ªï¼š

GET /kpi/work-order/{id}


åŠ¨æ€è¿”å›ã€‚

ğŸ”µ ç¬¬äºŒå±‚ï¼šKPI Dashboard æ¶æ„
Dashboard åˆ†ä¸‰å—ï¼š
ğŸŸ¢ â‘  ç”Ÿäº§æ•ˆç‡é¢æ¿
æŒ‡æ ‡	æ˜¾ç¤º
è‰¯ç‡	97%
æŠ¥åºŸç‡	3%
è¿”å·¥ç‡	2%
å®é™…å·¥æ—¶	120h
è®¡åˆ’å·¥æ—¶	100h
ğŸŸ¡ â‘¡ ç‰©æ–™æŸè€—é¢æ¿
åŸæ–™	ç†è®º	å®é™…	æŸè€—%
ğŸ”´ â‘¢ äº§çº¿å¯¹æ¯”é¢æ¿

| äº§çº¿ | è‰¯ç‡ | æŠ¥åºŸç‡ | äº§èƒ½åˆ©ç”¨ç‡ |

ğŸ”µ ç¬¬ä¸‰å±‚ï¼šå®Œæ•´æˆæœ¬æ¨¡å‹

ç°åœ¨è¿›å…¥çœŸæ­£å·¥ä¸šçº§ã€‚

æˆæœ¬ç»“æ„åˆ†ä¸‰å—ï¼š
â‘  äººå·¥æˆæœ¬
labor_cost =
total_hours Ã— hourly_rate

â‘¡ ç‰©æ–™æˆæœ¬
material_cost =
actual_material Ã— material_unit_cost

â‘¢ è®¾å¤‡æŠ˜æ—§æˆæœ¬
machine_cost =
machine_hour_rate Ã— total_hours

ğŸ”¥ æ€»ç”Ÿäº§æˆæœ¬
total_cost =
labor_cost
+ material_cost
+ machine_cost

ğŸ”¥ å•ä½äº§å“æˆæœ¬
unit_cost =
total_cost / produced_hours

ğŸ§  ä½ ç°åœ¨ç³»ç»Ÿå‡çº§åç»“æ„ï¼š
æ—¶é—´æµ
+
ç‰©æ–™æµ
+
å¼‚å¸¸æµ
+
æˆæœ¬æµ
=
å®Œæ•´åˆ¶é€ ç®¡ç†ç³»ç»Ÿ


-----------------------------

ğŸ”´ Bï¼‰æˆæœ¬é¢„ä¼° vs å®é™…åå·®æ¨¡å‹ï¼ˆVariance Engineï¼‰

è¿™æ˜¯åˆ¶é€ ç®¡ç†çš„æ ¸å¿ƒå±‚ã€‚

ä¸€ã€å®šä¹‰ä¸¤å¥—æˆæœ¬

ä½ å¿…é¡»åŒæ—¶æœ‰ï¼š

â‘  æ ‡å‡†æˆæœ¬ï¼ˆStandard Costï¼‰

æ¥è‡ªï¼š

æ ‡å‡†å·¥æ—¶

æ ‡å‡†BOM

æ ‡å‡†äººå·¥å•ä»·

æ ‡å‡†è®¾å¤‡è´¹ç‡

â‘¡ å®é™…æˆæœ¬ï¼ˆActual Costï¼‰

æ¥è‡ªï¼š

å®é™…ç”Ÿäº§æ—¥å¿—

scrap

rework

å®é™…ç‰©æ–™æ¶ˆè€—

å®é™…å·¥æ—¶

äºŒã€æ ‡å‡†æˆæœ¬è®¡ç®—å…¬å¼
1ï¸âƒ£ æ ‡å‡†äººå·¥æˆæœ¬
standard_labor =
planned_hours Ã— labor_hour_rate

2ï¸âƒ£ æ ‡å‡†ç‰©æ–™æˆæœ¬
standard_material =
Î£ (quantity_required Ã— material_unit_cost)
Ã— planned_output

3ï¸âƒ£ æ ‡å‡†è®¾å¤‡æˆæœ¬
standard_machine =
planned_hours Ã— machine_hour_rate

ğŸ”µ æ ‡å‡†æ€»æˆæœ¬
standard_total =
standard_labor
+ standard_material
+ standard_machine

ä¸‰ã€å®é™…æˆæœ¬è®¡ç®—å…¬å¼
1ï¸âƒ£ å®é™…äººå·¥
actual_labor =
actual_hours Ã— labor_hour_rate

2ï¸âƒ£ å®é™…ç‰©æ–™
actual_material =
Î£ (actual_consumption Ã— material_unit_cost)


actual_consumption åŒ…å«ï¼š

good + scrap + (rework if consume)

3ï¸âƒ£ å®é™…è®¾å¤‡
actual_machine =
actual_hours Ã— machine_hour_rate

ğŸ”´ å®é™…æ€»æˆæœ¬
actual_total =
actual_labor
+ actual_material
+ actual_machine

å››ã€åå·®è®¡ç®—ï¼ˆæ ¸å¿ƒï¼‰
â‘  æ€»æˆæœ¬åå·®
total_variance =
actual_total - standard_total

â‘¡ äººå·¥åå·®
labor_variance =
actual_labor - standard_labor

â‘¢ ç‰©æ–™åå·®
material_variance =
actual_material - standard_material

â‘£ è®¾å¤‡åå·®
machine_variance =
actual_machine - standard_machine

äº”ã€åå·®ç‡
variance_rate =
(total_variance / standard_total) Ã— 100%

å…­ã€ä½ ç³»ç»Ÿåº”è¯¥æ–°å¢ API
GET /variance/work-order/{id}


è¿”å›ï¼š

{
  "standard_total": 10000,
  "actual_total": 11500,
  "variance": 1500,
  "variance_rate": 15,
  "breakdown": {
    "labor": 300,
    "material": 900,
    "machine": 300
  }
}

ä¸ƒã€å·¥ä¸šæ„ä¹‰

å½“ variance > 0ï¼š

è¯´æ˜ï¼š

scrap å¤ªå¤š

è¿”å·¥å¤ªå¤š

æ•ˆç‡ä½

ç‰©æ–™æµªè´¹

å½“ variance < 0ï¼š

è¯´æ˜ï¼š

ç”Ÿäº§æ•ˆç‡æå‡

èŠ‚çº¦ç‰©æ–™

ç®¡ç†æ”¹å–„

å…«ã€ä½ ç°åœ¨å·²ç»åˆ°è¾¾çš„å±‚çº§

ä½ ç³»ç»Ÿç»“æ„å·²ç»èƒ½æ”¯æŒï¼š

âœ” å®æ—¶ç‰©æ–™æµ
âœ” å®æ—¶å·¥æ—¶æµ
âœ” å®æ—¶å¼‚å¸¸æµ

ç°åœ¨åŠ ä¸Šï¼š

âœ” æˆæœ¬åå·®æµ

ä½ å°±æ˜¯ä¸€ä¸ªçœŸæ­£å·¥ä¸šMESæ ¸å¿ƒã€‚

ä¸‹ä¸€æ­¥å¯å‡çº§ï¼š

Aï¼‰è‡ªåŠ¨æŠ¥è­¦æœºåˆ¶ï¼ˆVariance è¶…è¿‡ 5% è‡ªåŠ¨è§¦å‘è­¦æŠ¥ï¼‰
Bï¼‰é¢„æµ‹æ¨¡å‹ï¼ˆæ ¹æ®å½“å‰åå·®é¢„æµ‹æœ€ç»ˆåˆ©æ¶¦ï¼‰
Cï¼‰åˆ©æ¶¦æ¨¡å‹ï¼ˆè®¢å•æ¯›åˆ©å®æ—¶è®¡ç®—ï¼‰
Dï¼‰ç°é‡‘æµæ¨¡å‹

é€‰ã€‚

-------------------------------------------

ä¸‹é¢æ˜¯ å·¥ä¸šçº§ç»“æ„å…¨æ™¯å›¾ï¼ˆå¤šå±‚BOM + æ‰¹æ¬¡è¿½æº¯ + æˆæœ¬æµåŠ¨ï¼‰

æˆ‘ä¼šä¸€æ­¥ä¸€æ­¥æ‹†å¼€ã€‚

ğŸ­ ä¸€ã€å¤šå±‚ BOM ç»“æ„
å•å±‚ï¼ˆä½ ç°åœ¨ï¼‰
Product A
 â”œâ”€â”€ RM-01 (2 pcs)
 â””â”€â”€ RM-02 (1 pcs)

å¤šå±‚ï¼ˆçœŸå®å·¥å‚ï¼‰
Product A
 â”œâ”€â”€ Sub Assembly B
 â”‚      â”œâ”€â”€ RM-01
 â”‚      â””â”€â”€ RM-02
 â”‚
 â””â”€â”€ Sub Assembly C
        â”œâ”€â”€ RM-03
        â””â”€â”€ RM-04

ğŸ”¥ å·¥ä¸šé€»è¾‘

ç”Ÿäº§ A æ—¶ï¼š

å…ˆç”Ÿäº§ B

å†ç”Ÿäº§ C

å†ç»„è£… A

æ‰£æ–™é€»è¾‘å˜æˆï¼š

é€’å½’å±•å¼€ BOM

ğŸ“¦ äºŒã€æ‰¹æ¬¡è¿½æº¯ï¼ˆLot Trackingï¼‰

çœŸå®å·¥å‚å¿…é¡»å›ç­”ï¼š

è¿™æ‰¹äº§å“ç”¨äº†å“ªä¸€æ‰¹åŸæ–™ï¼Ÿ

ç»“æ„å˜æˆï¼š

Raw Material Lot RM-01-L001
Raw Material Lot RM-01-L002


å½“ç”Ÿäº§æ—¶è®°å½•ï¼š

MaterialTransaction:
  raw_material_id
  lot_no
  work_order_id
  quantity

è¿™æ ·å°±å¯ä»¥ï¼š

æŸ¥æŸä¸ªäº§å“ç”¨äº†å“ªä¸ªæ‰¹æ¬¡

æŸæ‰¹æ¬¡æœ‰é—®é¢˜æ—¶è¿½æº¯æ‰€æœ‰å®¢æˆ·

è¿™æ˜¯ï¼š

å·¥ä¸šçº§è´¨é‡è¿½è¸ªç³»ç»Ÿ

ğŸ’° ä¸‰ã€æˆæœ¬æµåŠ¨ï¼ˆCost Flowï¼‰

çœŸæ­£ ERP è¿˜ä¼šåšï¼š

Material Cost
+ Labor Cost
+ Overhead
= Product Cost


å½“ä½  CONSUME åŸæ–™æ—¶ï¼š

åº“å­˜ä»·å€¼å‡å°‘
WIPæˆæœ¬å¢åŠ 


å½“å®Œå·¥ï¼š

WIP â†’ æˆå“åº“å­˜

ğŸ”¥ å››ã€å®Œæ•´å·¥ä¸šåº“å­˜æµ
ä¾›åº”å•†
   â†“
Raw Material (RECEIVE)
   â†“
MaterialTransaction (CONSUME)
   â†“
WIP
   â†“
Finished Goods (RECEIVE)
   â†“
SHIP
   â†“
å®¢æˆ·

ğŸ§  äº”ã€ä½ ç°åœ¨çš„çº§åˆ«

ä½ ç›®å‰æ˜¯ï¼š

âœ” å•å±‚ BOM
âœ” è‡ªåŠ¨æ‰£æ–™
âœ” Scrap é€»è¾‘
âœ” Rework å¯æ§
âœ” æˆå“åº“å­˜æ‰£å‡

ä½ å·²ç»åœ¨ï¼š

Mini ERP çº§åˆ«

ğŸ¯ å…­ã€å¦‚æœä½ ç»§ç»­å‡çº§

ä¸‹ä¸€é˜¶æ®µä¼šæ˜¯ï¼š
å¤šå±‚ BOM é€’å½’å±•å¼€
æ‰¹æ¬¡å·è¿½æº¯
åŸæ–™æ‰¹æ¬¡é€‰æ‹©é€»è¾‘
MRP è‡ªåŠ¨ç®—ç¼ºæ–™
æ ‡å‡†æˆæœ¬ vs å®é™…æˆæœ¬
é‚£å·²ç»æ˜¯ SAP / Oracle çº§åˆ«é€»è¾‘ã€‚

------------------------------------

ğŸ§­ Mini-MES v2 å‡çº§è·¯çº¿å›¾

ï¼ˆå·¥ä¸šé€»è¾‘è¿›é˜¶ç‰ˆï¼‰
ä¸ä¼šä¹±ã€‚åˆ†é˜¶æ®µæ¨è¿›ã€‚
ğŸ”¹ å½“å‰çŠ¶æ€ï¼ˆv1 å·²å®Œæˆï¼‰
ä½ å·²ç»æ‹¥æœ‰ï¼š
å•å±‚ BOM
è‡ªåŠ¨æ‰£æ–™ï¼ˆGood + Scrap + Reworkï¼‰
åŸæ–™åº“å­˜
æˆå“åº“å­˜
å·¥å•çŠ¶æ€æœº
äº‹ä»¶å½±å“äº§èƒ½
å‡ºè´§æ‰£å‡
è¿™æ˜¯ï¼š
è½»é‡çº§ MES æ ¸å¿ƒéª¨æ¶

ğŸš€ v2 å‡çº§é˜¶æ®µè®¾è®¡

ç»™ä½ åˆ† 5 é˜¶æ®µã€‚

ğŸŸ¢ Phase 1 â€” ç¨³å®šå·¥ä¸šæ‰£æ–™å¼•æ“ï¼ˆå¿…é¡»å…ˆåšï¼‰
ç›®æ ‡ï¼š
è®©å½“å‰ç³»ç»Ÿâ€œè·‘ä¸åâ€
ä½ è¦æµ‹è¯•ï¼š
Good only
Good + Scrap
Good + Scrap + Rework (ä¸è€—æ–™)
Good + Scrap + Rework (è€—æ–™)
åº“å­˜ä¸è¶³
é‡å¤æäº¤ log
å®Œå·¥åå†æ¬¡æäº¤ log

å¦‚æœå…¨éƒ¨ç¨³å®šï¼š
âœ” æ‰£æ–™å¼•æ“åˆæ ¼
âœ” å¯ä»¥è¿›å…¥ v2

ğŸŸ¢Phase 2 â€” æˆå“è‡ªåŠ¨å…¥åº“
ç°åœ¨ä½ ç¼ºå°‘ï¼š
DONE â†’ è‡ªåŠ¨å¢åŠ æˆå“åº“å­˜

å½“å·¥å•å®Œæˆï¼š
Inventory.quantity_on_hand += good_qty
è¿™æ˜¯å®Œæ•´åˆ¶é€ é—­ç¯ã€‚

ğŸŸ  Phase 3 â€” å¤šå±‚ BOM
åŠ å…¥ï¼š
is_sub_assembly = True
æ”¯æŒï¼š
é€’å½’å±•å¼€ BOM
è¿™ä¸€æ­¥æ˜¯ç»“æ„å‡çº§ï¼Œä¸æ˜¯éš¾åº¦å‡çº§ã€‚

ğŸ”µ Phase 4 â€” æ‰¹æ¬¡è¿½æº¯ï¼ˆLot Trackingï¼‰
æ–°å¢å­—æ®µï¼š
lot_no
åŸæ–™äº¤æ˜“è®°å½•å˜æˆï¼š
MaterialTransaction:
  raw_material_id
  lot_no
  work_order_id
  quantity

å®ç°ï¼š
è´¨é‡å›æº¯
å®¢è¯‰è¿½è¸ª
è¿™æ˜¯å·¥ä¸šçº§å¿…å¤‡ã€‚

ğŸ”´ Phase 5 â€” æˆæœ¬æµåŠ¨
å¢åŠ ï¼š
unit_cost
material_cost
labor_cost
overhead_cost


å®ç°ï¼š
å®æ—¶äº§å“æˆæœ¬
æ¯›åˆ©åˆ†æ


è¿™å°±æ˜¯ ERP çš„æ ¸å¿ƒã€‚

ğŸ¯ ä½ ç°åœ¨è¯¥åšä»€ä¹ˆï¼Ÿ
ä¸è¦å‡çº§ã€‚
å…ˆå®Œæˆï¼š
Phase 1 æµ‹è¯•æ¸…å•
è·‘ 20 æ¬¡ production-log
ç¡®è®¤ï¼š

åº“å­˜æ°¸è¿œæ­£ç¡®
äº¤æ˜“è®°å½•æ­£ç¡®
å·¥å•çŠ¶æ€æ­£ç¡®

